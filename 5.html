<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Royal Success Archive | üëë Oceanic Majesty</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900&family=Patrick+Hand&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --navy: #02060c; --paper: #fdfaf0; --ink: #1a1a1a;
            --gold: #d4af37; --gold-foil: #f1c40f; --wax: #8b0000;
            --leaf: #10b981; --royal-blue: #0a1b33; --ocean-deep: #001f3f;
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; }
        
        body {
            font-family: 'Patrick Hand', cursive; 
            background: var(--ocean-deep);
            margin: 0; padding: 0; display: flex; justify-content: center; align-items: center;
            min-height: 100vh; overflow: hidden; perspective: 1500px;
            touch-action: pan-y; 
        }

        /* --- OCEAN BACKGROUND --- */
        #ocean-bg { position: fixed; inset: 0; z-index: -1; overflow: hidden; background: radial-gradient(circle at center, #003366 0%, #001f3f 100%); }
        .sea-creature { position: absolute; font-size: 2rem; opacity: 0.6; filter: blur(0.5px); pointer-events: none; animation: swim 25s infinite linear; }
        .fish { animation-duration: 20s; } .turtle { font-size: 3rem; animation-duration: 35s; } .bubble { font-size: 1rem; opacity: 0.3; animation: bubbleRise 10s infinite linear; color: #aaccff; }
        @keyframes swim { from { transform: translateX(-10vw) translateY(0) rotate(0deg); } to { transform: translateX(110vw) translateY(20vh) rotate(10deg); } }
        @keyframes bubbleRise { from { transform: translateY(110vh) scale(0.5); opacity: 0; } to { transform: translateY(-10vh) scale(1.5); opacity: 0.5; } }

        /* --- 3D BOOK ENGINE --- */
        .scene { 
            width: 94%; max-width: 440px; 
            height: 80vh; 
            transform-style: preserve-3d; 
            margin-bottom: 160px; /* Gap for buttons */
            position: relative;
        }
        .book { 
            position: relative; width: 100%; height: 100%; 
            background: var(--navy); border-radius: 20px; 
            transform-style: preserve-3d; 
            box-shadow: 0 60px 150px rgba(0,0,0,1); 
            transition: transform 0.15s ease-out; 
        }

        /* --- FIXED SILVER SPIRAL --- */
        .spiral-rail {
            position: absolute; top: -25px; left: 15px; width: calc(100% - 30px); height: 50px;
            display: flex; justify-content: space-between; z-index: 2000; pointer-events: none;
        }
        .coil-group {
            display: flex; flex-direction: column; align-items: center; width: 25px;
        }
        .wire {
            width: 12px; height: 45px; 
            /* Ocean Silver Gradient */
            background: linear-gradient(90deg, #222, #aaccff, #fff, #aaccff, #222);
            border-radius: 6px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.8);
            transform: rotate(-3deg);
        }
        .hole {
            width: 14px; height: 14px; background: #000; border-radius: 50%;
            margin-top: -12px; 
            box-shadow: inset 0 1px 3px rgba(100,100,255,0.2);
            z-index: -1;
        }

        /* --- COVER --- */
        .cover { 
            position: absolute; inset: 0; background: radial-gradient(circle at 50% 50%, #0d1f3d 0%, #02060c 100%);
            border-radius: 20px; z-index: 500; transform-origin: top; 
            transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            backface-visibility: hidden; cursor: pointer; border: 3px solid var(--gold); overflow: hidden;
        }
        .bg-layer { position: absolute; font-family: 'Montserrat', sans-serif; font-weight: 900; color: rgba(212, 175, 55, 0.05); pointer-events: none; text-transform: uppercase; line-height: 0.8; transition: transform 0.2s; }
        #succ-bg { font-size: 10rem; top: 5%; left: -5%; }
        
        .main-plate {
            z-index: 10; padding: 40px; border: 2px solid var(--gold);
            background: rgba(0,0,0,0.8); text-align: center; border-radius: 4px;
            backdrop-filter: blur(15px); transform: translateZ(90px);
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.4);
        }
        .main-plate h1 { margin: 0; font-family: 'Playfair Display', serif; font-size: 2.8rem; color: #fff; letter-spacing: 5px; text-shadow: 0 2px 15px var(--gold); }
        .main-plate p { color: var(--gold); margin-top: 15px; font-size: 0.8rem; letter-spacing: 4px; font-weight: bold; }
        .book.open .cover { transform: rotateX(165deg); }

        /* --- PAGES --- */
        .page-container { position: absolute; inset: 10px; transform-style: preserve-3d; }
        .page { 
            position: absolute; inset: 0; background: var(--paper); 
            padding: 30px 25px 25px 25px; 
            border-radius: 8px; transform-origin: top; 
            backface-visibility: hidden; transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1); z-index: 10; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            border: 1px solid #e0d0b0; box-shadow: inset 0 0 80px rgba(197, 160, 89, 0.1);
            touch-action: pan-y;
        }
        .page.flipping { transform: rotateX(180deg) scale(1.02); filter: brightness(0.9); }

        /* --- COMPONENTS --- */
        .growth-meter { height: 18px; background: #e2e8f0; border-radius: 20px; overflow: hidden; margin: 15px 0; border: 1px solid #cbd5e1; position: relative; }
        #growthFill { 
            width: 0%; height: 100%; 
            background: linear-gradient(90deg, #16a34a, #f1c40f, #c5a059, #16a34a);
            background-size: 300% 100%; animation: auraMove 4s infinite linear; transition: 1.5s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        @keyframes auraMove { 0% { background-position: 0% 0; } 100% { background-position: 100% 0; } }

        .section-tag { font-family: 'Playfair Display', serif; font-size: 1.1rem; color: var(--gold); margin: 25px 0 10px; border-bottom: 2px solid var(--gold); display: flex; align-items: center; gap: 8px; font-weight: 700; text-transform: uppercase; }
        .item-row { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid rgba(197,160,89,0.15); }
        .custom-check { width: 24px; height: 24px; accent-color: var(--gold); cursor: pointer; flex-shrink: 0; }
        .input-box { border: none; background: transparent; font-family: inherit; width: 100%; font-size: 1.15rem; color: var(--ink); line-height: 1.2; padding-top: 2px; }

        .habit-dock { display: flex; justify-content: space-around; padding: 18px; background: #fff; border-radius: 20px; margin-bottom: 20px; border: 1px solid var(--gold); }
        .badge { font-size: 2.2rem; opacity: 0.2; transition: 0.4s; cursor: pointer; filter: grayscale(1); }
        .badge.active { opacity: 1; transform: scale(1.35) rotate(8deg); filter: grayscale(0); }

        .gita-box { margin-top: 40px; padding: 25px; border: 1px solid var(--gold); background: rgba(197, 160, 89, 0.05); border-radius: 8px; text-align: center; position: relative; font-style: italic; }
        .gita-box::before { content: 'üïâ'; position: absolute; top: -15px; left: 50%; transform: translateX(-50%); background: var(--paper); padding: 0 12px; color: var(--gold); font-size: 1.2rem; }
        .gita-text { font-family: 'Playfair Display', serif; color: var(--navy); font-size: 1.1rem; line-height: 1.6; display: block; margin-bottom: 10px; }
        .gita-ref { font-size: 0.85rem; color: var(--gold); font-weight: bold; letter-spacing: 2px; }

        .chart-container { margin: 20px 0; background: #fff; padding: 15px; border-radius: 15px; border: 1px solid var(--gold); }
        .chart-svg { width: 100%; height: 120px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        .chart-line { fill: none; stroke: var(--gold); stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; }

        .drawer-handle { background: var(--navy); color: var(--gold); padding: 16px; text-align: center; cursor: pointer; font-weight: bold; border-radius: 15px; margin-top: 25px; border: 2px solid var(--gold); }
        #pocket { max-height: 0; overflow: hidden; transition: 0.6s ease-in-out; }
        #pocket.open { max-height: 1000px; padding-top: 25px; }
        .polaroid-royal { width: 90%; background: #fff; padding: 12px 12px 55px 12px; box-shadow: 15px 25px 50px rgba(0,0,0,0.4); margin: 0 auto; border: 1px solid #eee; transform: rotate(-2deg); }
        .polaroid-royal img { width: 100%; min-height: 180px; object-fit: cover; background: #fafafa; }

        .signature-box { margin-top: 30px; text-align: center; }
        .signature-line { border: none; border-bottom: 2px solid var(--gold); background: transparent; font-family: 'Playfair Display', serif; font-size: 1.5rem; color: var(--navy); text-align: center; width: 80%; padding: 5px; font-style: italic; }

        /* --- NAV DOCK (Inline & Lifted) --- */
        .nav-dock { 
            position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); 
            display: flex; align-items: center; gap: 15px; 
            background: rgba(0,0,0,0.9); backdrop-filter: blur(25px); 
            padding: 10px 25px; border-radius: 80px; z-index: 5000; 
            border: 2px solid var(--gold); 
        }
        .nav-btn { 
            width: 50px; height: 50px; border-radius: 50%; 
            background: #fff; border: none; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; font-size: 1.4rem; transition: 0.3s; 
        }
        .nav-btn.main { 
            width: 60px; height: 60px; 
            background: var(--gold); color: white; 
            border: 4px solid var(--navy); font-size: 1.8rem; 
            transform: none; /* Inline alignment */
        }
        .nav-btn.main:hover { transform: scale(1.1); }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 6000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal { background: var(--paper); padding: 40px; border-radius: 30px; border: 3px solid var(--gold); width: 100%; max-width: 400px; text-align: center; }
        #waxSeal { position: absolute; bottom: 30px; right: 30px; width: 65px; height: 65px; background: var(--wax); border-radius: 50%; color: var(--gold); display: flex; align-items: center; justify-content: center; transform: scale(0); transition: 0.5s; cursor: pointer; z-index: 100; font-size: 1.8rem; }
    </style>
</head>
<body onload="init()">

    <div id="ocean-bg"></div>
    
    <div class="scene">
        <div class="book" id="book" onmousemove="handleMove(event)" onmouseleave="resetMove()">
            
            <div class="spiral-rail">
                <div class="coil-group"><div class="wire"></div><div class="hole"></div></div>
                <div class="coil-group"><div class="wire"></div><div class="hole"></div></div>
                <div class="coil-group"><div class="wire"></div><div class="hole"></div></div>
                <div class="coil-group"><div class="wire"></div><div class="hole"></div></div>
                <div class="coil-group"><div class="wire"></div><div class="hole"></div></div>
                <div class="coil-group"><div class="wire"></div><div class="hole"></div></div>
                <div class="coil-group"><div class="wire"></div><div class="hole"></div></div>
                <div class="coil-group"><div class="wire"></div><div class="hole"></div></div>
            </div>

            <div class="cover" onclick="openBook()">
                <div class="bg-layer" id="succ-bg">SUCCESS</div>
                <div class="main-plate">
                    <h1>ARCHIVE</h1>
                    <p>‚ú® Precision ‚Ä¢ Strategy ‚Ä¢ Power ‚ú®</p>
                </div>
            </div>

            <div class="page-container" id="swipeArea">
                <div class="page" id="page">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span id="dateDisp" style="color:var(--navy); font-weight:bold; font-family: 'Playfair Display'; font-size:1.4rem;"></span>
                        <span id="percDisp" style="color:var(--leaf); font-weight:bold; font-size: 1.2rem;">0% ‚ú®</span>
                    </div>
                    <div class="growth-meter"><div id="growthFill"></div></div>

                    <div class="section-tag">üå∏ Royal Habits</div>
                    <div class="habit-dock">
                        <span class="badge" onclick="tapHabit('water')" id="h_water">üíß</span>
                        <span class="badge" onclick="tapHabit('gym')" id="h_gym">üí™</span>
                        <span class="badge" onclick="tapHabit('read')" id="h_read">üìö</span>
                        <span class="badge" onclick="tapHabit('sun')" id="h_sun">‚òÄÔ∏è</span>
                        <span class="badge" onclick="tapHabit('zen')" id="h_zen">üßò</span>
                    </div>

                    <div class="section-tag">üéØ Core Goals</div>
                    <div id="goalsList"></div>

                    <div class="section-tag">üï∞Ô∏è Royal Timeline</div>
                    <div id="schedule"></div>

                    <textarea id="notes" class="save" style="margin-top:25px; height:120px; border-left:4px solid var(--gold); padding:15px; width:100%; border:none; background:rgba(197, 160, 89, 0.05); font-size: 1.15rem;" placeholder="Record today's royal victories..." oninput="save()"></textarea>

                    <div class="gita-box">
                        <span id="gitaTxt" class="gita-text"></span>
                        <span id="gitaRef" class="gita-ref"></span>
                    </div>

                    <div class="drawer-handle" onclick="toggleDrawer()">üóùÔ∏è ACCESS SECRET COMPARTMENT</div>
                    <div id="pocket">
                        <div class="polaroid-royal" onclick="document.getElementById('imgInp').click()">
                            <img id="userImg" src="">
                            <p style="text-align:center; font-size:0.9rem; color:#888; margin-top:15px; font-weight: bold; letter-spacing: 2px;">‚öú MEMORIAM ‚öú</p>
                        </div>
                        <textarea id="secret" class="save" style="height:120px; width:100%; border:1px solid #e0d0b0; margin-top:20px; padding:15px; border-radius:8px; background: #fff;" placeholder="Private royal thoughts..." oninput="save()"></textarea>
                    </div>
                    
                    <div class="signature-box">
                        <p style="font-family: 'Playfair Display'; color: var(--navy); font-size: 0.9rem; letter-spacing: 2px; margin-bottom: 5px; font-weight:bold;">ROYAL SIGNATURE</p>
                        <input type="text" id="royalSignature" class="save signature-line" placeholder="Sign Here..." oninput="save()">
                    </div>

                    <div id="waxSeal" onclick="toggleSeal()">‚öú</div>
                </div>
            </div>
        </div>
    </div>

    <audio id="flipSound"><source src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" type="audio/mpeg"></audio>
    <input type="file" id="imgInp" hidden accept="image/*" onchange="processImg(event)">

    <div class="overlay" id="calOverlay" onclick="this.style.display='none'">
        <div class="modal" onclick="event.stopPropagation()">
            <h2 style="font-family: 'Playfair Display'; color: var(--gold);">üìÖ Archive Map</h2>
            <button onclick="jumpToday()" style="width:100%; padding:16px; background:var(--gold); border:none; color:white; border-radius:15px; font-weight:bold; margin-bottom:25px; cursor:pointer;">üëë BACK TO TODAY</button>
            <div id="calGrid" style="display:grid; grid-template-columns: repeat(7, 1fr); gap: 10px;"></div>
        </div>
    </div>

    <div class="overlay" id="reportOverlay" onclick="this.style.display='none'">
        <div class="modal" onclick="event.stopPropagation()">
            <h2 style="font-family: 'Playfair Display'; color: var(--gold);">‚öú ROYAL PROGRESS ‚öú</h2>
            <div style="font-size: 5rem; font-weight: 900; color: var(--leaf);" id="reportPerc">0%</div>
            <div class="chart-container">
                <p style="font-size: 0.8rem; color: var(--gold); font-weight: bold; margin-bottom: 10px;">7-DAY HISTORY</p>
                <svg class="chart-svg" id="historyChart" viewBox="0 0 350 120">
                    <polyline class="chart-line" points="50,110 100,110 150,110 200,110 250,110 300,110" id="chartLine"></polyline>
                </svg>
            </div>
            <button onclick="document.getElementById('reportOverlay').style.display='none'" style="width:100%; padding:16px; background:var(--navy); color:white; border-radius:15px; border:none; font-weight:bold; cursor:pointer;">PROCEED</button>
        </div>
    </div>

    <nav class="nav-dock">
        <button class="nav-btn" onclick="openCal()">üìÖ</button>
        <button class="nav-btn main" onclick="closeBook()">üëë</button>
        <button class="nav-btn" onclick="syncLast()">ü™Ñ</button>
        <button class="nav-btn" onclick="clearDay()">üßπ</button>
        <button class="nav-btn" onclick="openReport()">üìä</button>
    </nav>

<script>
    let vDate = new Date(); vDate.setHours(0,0,0,0);
    let flipping = false, sealed = false, habits = {};
    const SVG_PLACE = "data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='350' height='300'%3E%3Crect width='350' height='300' fill='%23f5f5f5'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='serif' font-size='18' fill='%23c5a059'%3ETap to Upload Memoriam%3C/text%3E%3C/svg%3E";

    let touchStartX = 0;
    let touchStartY = 0;

    const GITA_QUOTES = [
        {t: "You have a right to perform your prescribed duties, but you are not entitled to the fruits of your actions.", r: "Verse 2.47"},
        {t: "Man is made by his belief. As he believes, so he is.", r: "Verse 17.3"},
        {t: "A man's own self is his friend. A man's own self is his foe.", r: "Verse 6.5"},
        {t: "The soul is neither born, and nor does it die.", r: "Verse 2.20"},
        {t: "Perform your obligatory duty, for action is better than inaction.", r: "Verse 3.8"}
    ];

    function init() {
        const bg = document.getElementById('ocean-bg');
        const creatures = ['üêü', 'üê†', 'üê°', 'ü¶à', 'üê¢', 'ü´ß'];
        for(let i=0; i<20; i++) {
            let c = document.createElement('div');
            c.className = i%2===0 ? 'sea-creature fish' : (i%5===0 ? 'sea-creature turtle' : 'sea-creature bubble');
            c.innerHTML = creatures[Math.floor(Math.random()*creatures.length)];
            c.style.left = Math.random()*90+'vw'; c.style.top = Math.random()*90+'vh';
            c.style.animationDelay = Math.random()*20+'s'; c.style.animationDuration = Math.random()*15+20+'s';
            bg.appendChild(c);
        }

        const gl = document.getElementById('goalsList'); gl.innerHTML = '';
        for(let i=1; i<=3; i++) {
            gl.innerHTML += `<div class="item-row"><input type="checkbox" id="gcheck_${i}" class="chk-save custom-check" onclick="save()"><input type="text" id="goal_${i}" class="save input-box" placeholder="Objective ${i}..." oninput="save()"></div>`;
        }

        const s = document.getElementById('schedule'); s.innerHTML = '';
        for(let h=6; h<=23; h++) {
            let lbl = h > 12 ? (h-12)+' PM' : (h==12 ? '12 PM' : h+' AM');
            s.innerHTML += `<div class="item-row"><span style="font-size:0.85rem; color:#94a3b8; width:55px; font-weight:bold;">${lbl}</span><input type="checkbox" id="c_${h}" class="chk-save custom-check" onclick="save()"><input type="text" id="t_${h}" class="save input-box" placeholder="..." oninput="save()"></div>`;
        }

        const swipeArea = document.getElementById('swipeArea');
        
        swipeArea.addEventListener('touchstart', e => { 
            touchStartX = e.changedTouches[0].screenX; 
            touchStartY = e.changedTouches[0].screenY;
        }, { passive: true });

        swipeArea.addEventListener('touchend', e => { 
            let touchEndX = e.changedTouches[0].screenX;
            let touchEndY = e.changedTouches[0].screenY;
            let diffX = touchStartX - touchEndX;
            let diffY = touchStartY - touchEndY;

            if (Math.abs(diffX) > 60 && Math.abs(diffX) > Math.abs(diffY)) {
                if (diffX > 0) turn(1); // Swipe Left -> Next
                else turn(-1);          // Swipe Right -> Prev
            }
        }, false);

        load();
    }

    function handleMove(e) {
        const b = document.getElementById('book'); if(b.classList.contains('open')) return;
        const rect = b.getBoundingClientRect();
        const rx = ((e.clientY - rect.top) / rect.height - 0.5) * -30;
        const ry = ((e.clientX - rect.left) / rect.width - 0.5) * 30;
        b.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg)`;
    }

    function resetMove() { document.getElementById('book').style.transform = `rotateX(0deg) rotateY(0deg)`; }

    function getID(d) { return `royal_ocean_v2_${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }

    function openBook() { document.getElementById('book').classList.add('open'); }
    function closeBook() { save(); document.getElementById('book').classList.remove('open'); }

    function turn(dir) {
        if(flipping) return; flipping = true; save();
        document.getElementById('flipSound').play().catch(()=>{});
        const p = document.getElementById('page'); p.classList.add('flipping');
        setTimeout(() => {
            vDate.setDate(vDate.getDate() + dir); load();
            p.style.transition = 'none'; p.style.transform = 'rotateX(0deg)';
            p.offsetHeight; p.style.transition = ''; p.classList.remove('flipping');
            flipping = false;
        }, 500);
    }

    function load() {
        const key = getID(vDate);
        const data = JSON.parse(localStorage.getItem(key)) || {};
        sealed = data.sealed || false; habits = data.habits || {};
        document.querySelectorAll('.save').forEach(el => { el.value = data[el.id] || ''; el.disabled = sealed; });
        document.querySelectorAll('.chk-save').forEach(el => { el.checked = data[el.id] || false; el.disabled = sealed; });
        document.getElementById('userImg').src = data.photo || SVG_PLACE;
        const ws = document.getElementById('waxSeal');
        ws.style.transform = sealed ? 'scale(1) rotate(-15deg)' : 'scale(0)';
        document.getElementById('page').classList.toggle('locked', sealed);
        document.getElementById('dateDisp').innerText = vDate.toLocaleDateString(undefined, {weekday: 'short', month:'short', day:'numeric'});
        const q = GITA_QUOTES[Math.abs(vDate.getDate() % GITA_QUOTES.length)];
        document.getElementById('gitaTxt').innerText = `"${q.t}"`;
        document.getElementById('gitaRef').innerText = `‚Äî BHAGAVAD GITA, ${q.r}`;
        updateHabitUI(); updateGrowth();
    }

    function save() {
        try {
            const data = { sealed, photo: document.getElementById('userImg').src, habits: habits };
            document.querySelectorAll('.save').forEach(el => data[el.id] = el.value);
            document.querySelectorAll('.chk-save').forEach(el => data[el.id] = el.checked);
            localStorage.setItem(getID(vDate), JSON.stringify(data));
            updateGrowth();
        } catch (e) { localStorage.removeItem(localStorage.key(0)); save(); }
    }

    function processImg(e) {
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = 600; let height = img.height * (600 / img.width);
                canvas.width = width; canvas.height = height;
                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                document.getElementById('userImg').src = canvas.toDataURL('image/jpeg', 0.5);
                save(); 
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(e.target.files[0]);
    }

    function updateGrowth() {
        let hPoints = Object.values(habits).filter(v => v).length;
        let tPoints = Array.from(document.querySelectorAll('.chk-save')).filter(x => x.checked).length;
        let p = Math.min(Math.round(((hPoints + tPoints) / 26) * 100), 100);
        document.getElementById('growthFill').style.width = p + '%';
        document.getElementById('percDisp').innerText = p + '% ‚ú®';
        return p;
    }

    function getHistory() {
        let pts = [];
        for(let i=6; i>=0; i--) {
            let d = new Date(vDate); d.setDate(d.getDate() - i);
            let data = JSON.parse(localStorage.getItem(getID(d))) || {};
            let h = Object.values(data.habits || {}).filter(v => v).length;
            let t = Object.keys(data).filter(k => k.startsWith('c_') && data[k]).length;
            let g = Object.keys(data).filter(k => k.startsWith('gcheck_') && data[k]).length;
            pts.push(Math.round(((h + t + g) / 26) * 100));
        }
        return pts;
    }

    function openReport() {
        const p = updateGrowth();
        document.getElementById('reportPerc').innerText = p + "%";
        const history = getHistory();
        let points = history.map((val, i) => `${50 + i * 42},${110 - val}`).join(' ');
        document.getElementById('chartLine').setAttribute('points', points);
        document.getElementById('reportOverlay').style.display = 'flex';
    }

    function tapHabit(id) { if(!sealed) { habits[id] = !habits[id]; updateHabitUI(); save(); } }
    function updateHabitUI() { ['water','gym','read','sun','zen'].forEach(id => {
        const b = document.getElementById('h_'+id); if(b) b.classList.toggle('active', !!habits[id]);
    }); }
    function toggleSeal() { sealed = !sealed; save(); load(); }
    function toggleDrawer() { document.getElementById('pocket').classList.toggle('open'); }
    function jumpToday() { vDate = new Date(); vDate.setHours(0,0,0,0); load(); document.getElementById('calOverlay').style.display='none'; }
    function syncLast() {
        let y = new Date(vDate); y.setDate(vDate.getDate()-1);
        const d = JSON.parse(localStorage.getItem(getID(y)));
        if(d && confirm("Mirror previous objectives?")) {
            habits = d.habits || {};
            for(let i=1; i<=3; i++) document.getElementById(`goal_${i}`).value = d[`goal_${i}`] || '';
            for(let h=6; h<=23; h++) document.getElementById(`t_${h}`).value = d[`t_${h}`] || '';
            save(); load();
        }
    }
    function clearDay() { if(confirm("Purge current record?")) { localStorage.removeItem(getID(vDate)); load(); } }
    function openCal() {
        const g = document.getElementById('calGrid'); g.innerHTML = '';
        for(let i=-10; i<=10; i++) {
            let d = new Date(); d.setDate(new Date().getDate() + i);
            let b = document.createElement('div');
            b.style = `padding:10px; border-radius:8px; cursor:pointer; background:${d.toDateString()===vDate.toDateString()?'var(--gold)':'#f1f5f9'}; color:${d.toDateString()===vDate.toDateString()?'#fff':'#111'}`;
            b.innerHTML = `<span style="font-size:0.6rem; display:block; opacity:0.6;">${d.toLocaleDateString(undefined,{weekday:'short'})}</span>${d.getDate()}`;
            b.onclick = () => { vDate = new Date(d); vDate.setHours(0,0,0,0); load(); document.getElementById('calOverlay').style.display='none'; };
            g.appendChild(b);
        }
        document.getElementById('calOverlay').style.display='flex';
    }
</script>
</body>
</html>